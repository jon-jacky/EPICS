vdb.py
======

**vdb.py** generates a data flow graph from an EPICS database (a
collection of *.db*, *.substitutions*, and *.template* files).

How it works
------------

**vdb.py** uses *parseDb* in
[epicsUtils](http://www-csr.bessy.de/control/bii_scripts/html/python/epicsUtils.html)
(download
[here](http://www-csr.bessy.de/control/bii_scripts/repo/bii_scripts/lib/python/epicsUtils.py))
from [BESSY](http://www-csr.bessy.de/) to load an EPICS database file
(in *.db* format) into a list of dictionaries, one dictionary per
EPICS record, where the dictionary keys are the field names (with one
additional key, *recordname*).  Then *vdb.py* generates a script in
the *dot* graph language where each node is an EPICS record and each
edge is a link: INP, OUT, FLNK, etc.  The edges are labelled so that
they indicate control flow as well as data flow.

**vdb.py** sends the *dot* graph script to standard output.  We
usually redirect it to a *.dot* file.  Then our *dotsvg* script uses
the *dot* graph layout program from the
[Graphviz](http://www.graphviz.org/) package to generate an *.svg*
graphics file, which can be viewed in a browser.  The layout
generated by *dot* usually makes the data flow and
control flow clear.

For EPICS databases that are described by *.substitutions* and
*.template* files, we convert these to *.db* files using
[msi](http://www.aps.anl.gov/epics/EpicsDocumentation/ExtensionsManuals/msi/msi.html),
the EPICS *macro substitution and include tool*.


Input files
----------

The input files for *vdp.py* are EPICS database files in *.db
format.  Many examples are in the *.vdb* files in the [db](../db)
directory.

Most of the database files from our EPICS CNTS program are not
suitable for input to *vdb.py*.  They usually require some manual
preprocessing with *msi*, other shell commands, and a text editor to
produce our *.vdb* files (see below).  This preprocessing is
inconvenient, and discourages using *vdb.py* frequently.

Our *.vdb* files in this repository are not in exactly the same format
as the *.vdb* files used with the EPICS *vdct* program (because *.vdb*
files for *vdct* include graphics layout information for that
program).  The identical extension names are a (confusing) coincidence.


Output files
-----------

The output files from *vdp.py* are *.dot* files.  

The *.dot* files are inputs to our *dotsvg* script.  The outputs from
*dotsvg* are *.svg* files that can be displayed in a browser to show
the data flow diagrams.

Many examples of *.dot* and *.svg* files are in the [db](../db)
directory.


Commands
--------

Some examples:

- *vdb.py dosimetry.vdb > dosimetry.dot* processes *dosimetry.vdb* to
   produce *dosimetry.dot*

- *dotsvg dosimetry* processes *dosimetry.dot* to produce *dosimetry.svg*.

- *msi_subs.sh session* processes *session.substitutions* and all its
referenced *.template* files to produce *session_subs.db*.

*vdb.py*, *dotsvg*, and *msi_subs.sh* are in the [bin](../bin) directory.

Many *.sh* scripts in the [bin](../bin) directory contain examples of
these commands.  These scripts are intended to be run from the
[db](../db) directory, by commands such as: *./bin/dosimetry_vdb.sh*.

The *.sh* scripts define *PATH* and *PYTHONPATH* as needed at the
author's site, so they will not work anywhere else.


Preprocessing the input data
----------------------------

Most of the database files from our EPICS CNTS program are not
suitable for input to *vdb.py*.  They usually require some manual
pre-processing with *msi*, other shell commands, and a text editor.
We name our preprocessed files *.vdb* to distinguish them from the
original *.db* files.

Some typical preprocessing steps:

- Convert records described by *.substitutions* and *.template* files
to *.db* files.  Use
[msi](http://www.aps.anl.gov/epics/EpicsDocumentation/ExtensionsManuals/msi/msi.html),
the EPICS *macro substitution and include tool*.  For example,
*msi_subs.sh session* processes *session.substitutions* and all its
referenced *.template* files to produce *session_subs.db*.  See
comments in *msi_subs.sh* for more details.

- Shorten PV names.  Our database records typically have long names,
for example *Iso:Dosimetry:Settings:Readiness*.  These would make the
data flow diagram cluttered and difficult to read.  Use a text editor
to remove the common prefix from all the record names from the *.db* file,
leaving only *Settings:Readiness* in the *.vdb* file.

- Quote field values.  Apparently *parseDb* in *epicsUtils* requires
all field values to be quoted, even numbers.  For example our *.db*
files often say *DOL1, 1*.  Use a text editor to change this to *DOL1,
"1"* in the *.vdb* file.

- Concatenate files.  Our *vdb.py* takes a single input file.  To see
the data flow among records described in several files, simply
concatenate several *.vdb* files into one, using a text editor or the
*cat* command.  In our concatenated *.vdb* files, sometimes *parseDb*
ignores the segments after the first file --- we don't know why.  Our
workaround is to simply concatenate the files in a different order.

- (others we might have forgotten)

All this preprocessing is inconvenient, and discourages using *vdb.py*
frequently.

Revised December 2014

?